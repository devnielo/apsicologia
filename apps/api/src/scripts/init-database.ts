#!/usr/bin/env tsx

import mongoose from 'mongoose';
import { User } from '../models/User.js';
import { Professional } from '../models/Professional.js';
import { Patient } from '../models/Patient.js';
import { createAdminUser } from './create-admin.js';
import seedDatabase from './seed-data.js';
import database from '../config/database.js';
import logger from '../config/logger.js';
import bcrypt from 'bcrypt';

interface InitOptions {
  skipAdmin?: boolean;
  skipSeed?: boolean;
  adminData?: {
    name: string;
    email: string;
    password: string;
    phone?: string;
  };
}

async function initializeDatabase(options: InitOptions = {}): Promise<void> {
  try {
    console.log('üöÄ Initializing apsicologia Database');
    console.log('=====================================');
    
    // Connect to database
    console.log('üîß Connecting to database...');
    await database.connect();
    console.log('‚úÖ Database connected successfully');

    // Check if database is already initialized
    const existingUsers = await User.countDocuments();
    
    if (existingUsers > 0 && !process.env.FORCE_INIT) {
      console.log('‚ÑπÔ∏è  Database already contains users. Skipping initialization.');
      console.log('   Use FORCE_INIT=true environment variable to force re-initialization.');
      return;
    }

    if (existingUsers > 0 && process.env.FORCE_INIT) {
      console.log('‚ö†Ô∏è  FORCE_INIT detected. Proceeding with re-initialization...');
    }

    // Step 1: Create admin user
    if (!options.skipAdmin) {
      console.log('\nüìã Step 1: Creating admin user...');
      
      const adminData = options.adminData || {
        name: 'Administrador Principal',
        email: 'admin@arribapsicologia.com',
        password: 'SecureAdmin2024!',
        phone: '+34600000000',
      };

      let adminUser;
      try {
        adminUser = await createAdminUser(adminData);
        console.log('‚úÖ Admin user created successfully');
      } catch (error) {
        if (error instanceof Error && error.message.includes('already exists')) {
          console.log('‚ÑπÔ∏è  Admin user already exists, skipping...');
          // Buscar el admin existente
          adminUser = await User.findOne({ email: adminData.email });
        } else {
          throw error;
        }
      }
    } else {
      console.log('\n‚è≠Ô∏è  Step 1: Skipping admin user creation');
    }

    // Step 2: Crear usuarios de prueba adicionales
    logger.info('üë• Creando 10 usuarios de prueba adicionales...');
    
    // Asegurar conexi√≥n a la base de datos
    await database.connect();
    
    // Datos para usuarios de prueba
    const testUsers = [
      // 3 Profesionales
      {
        name: 'Dr. Carlos Mendoza Silva',
        email: 'carlos.mendoza@arribapsicologia.com',
        phone: '+34 666 123 789',
        role: 'professional',
        password: 'Professional2024!'
      },
      {
        name: 'Dra. Ana Rodr√≠guez L√≥pez',
        email: 'ana.rodriguez@arribapsicologia.com',
        phone: '+34 666 456 123',
        role: 'professional',
        password: 'Professional2024!'
      },
      {
        name: 'Dr. Miguel Santos Garc√≠a',
        email: 'miguel.santos@arribapsicologia.com',
        phone: '+34 666 789 456',
        role: 'professional',
        password: 'Professional2024!'
      },
      // 7 Pacientes
      {
        name: 'Mar√≠a Garc√≠a P√©rez',
        email: 'maria.garcia@email.com',
        phone: '+34 666 111 222',
        role: 'patient',
        password: 'Patient2024!'
      },
      {
        name: 'Juan P√©rez Mart√≠n',
        email: 'juan.perez@email.com',
        phone: '+34 666 333 444',
        role: 'patient',
        password: 'Patient2024!'
      },
      {
        name: 'Carmen L√≥pez Ruiz',
        email: 'carmen.lopez@email.com',
        phone: '+34 666 555 777',
        role: 'patient',
        password: 'Patient2024!'
      },
      {
        name: 'Pedro Mart√≠n Torres',
        email: 'pedro.martin@email.com',
        phone: '+34 666 888 999',
        role: 'patient',
        password: 'Patient2024!'
      },
      {
        name: 'Luc√≠a Fern√°ndez Vega',
        email: 'lucia.fernandez@email.com',
        phone: '+34 666 000 111',
        role: 'patient',
        password: 'Patient2024!'
      },
      {
        name: 'Diego Ruiz Castro',
        email: 'diego.ruiz@email.com',
        phone: '+34 666 222 333',
        role: 'patient',
        password: 'Patient2024!'
      },
      {
        name: 'Sandra Torres Jim√©nez',
        email: 'sandra.torres@email.com',
        phone: '+34 666 444 555',
        role: 'patient',
        password: 'Patient2024!'
      }
    ];

    // Crear usuarios con validaci√≥n de existencia
    let createdCount = 0;
    let skippedCount = 0;

    for (const userData of testUsers) {
      try {
        // Verificar si el usuario ya existe
        const existingUser = await User.findOne({ email: userData.email });
        
        if (existingUser) {
          logger.info(`‚ö†Ô∏è  Usuario ya existe: ${userData.name} (${userData.email})`);
          skippedCount++;
          continue;
        }

        // Hashear contrase√±a
        const hashedPassword = await bcrypt.hash(userData.password, 12);

        // Crear nuevo usuario
        const newUser = new User({
          name: userData.name,
          email: userData.email,
          passwordHash: hashedPassword,
          phone: userData.phone,
          role: userData.role,
          profileImage: null, // Campo opcional para foto de perfil
          isActive: true,
          isEmailVerified: true,
          isTwoFactorEnabled: false,
          failedLoginAttempts: 0,
          preferences: {
            language: 'es',
            timezone: 'Europe/Madrid',
            notifications: {
              email: true,
              sms: false,
              push: true,
            }
          },
          createdAt: new Date(),
          updatedAt: new Date(),
        });

        await newUser.save();
        logger.info(`‚úÖ Usuario creado: ${userData.name} (${userData.role})`);
        createdCount++;

      } catch (error) {
        logger.error(`‚ùå Error creando usuario ${userData.name}:`, error);
      }
    }

    logger.info(`üìä Resumen: ${createdCount} usuarios creados, ${skippedCount} ya exist√≠an`);

    // Step 3: Crear registros Patient para usuarios con rol patient
    logger.info('üè• Creando registros Patient para usuarios con rol patient...');
    
    // Obtener admin user para createdBy
    const adminUserForPatients = await User.findOne({ email: 'admin@arribapsicologia.com' });
    const patientUsers = await User.find({ role: 'patient' });
    let patientsCreated = 0;
    
    for (const user of patientUsers) {
      try {
        // Verificar si ya existe un registro Patient para este usuario
        const existingPatient = await Patient.findOne({ 
          $or: [
            { userId: user._id },
            { 'contactInfo.email': user.email }
          ]
        });
        
        if (existingPatient) {
          logger.info(`‚ö†Ô∏è  Patient ya existe para usuario: ${user.name}`);
          continue;
        }

        // Crear registro Patient b√°sico con datos m√°s realistas
        const patientData = {
          personalInfo: {
            firstName: user.name.split(' ')[0] || 'Nombre',
            lastName: user.name.split(' ').slice(1).join(' ') || 'Apellido',
            fullName: user.name,
            dateOfBirth: new Date(1985 + Math.floor(Math.random() * 15), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1),
            age: 25 + Math.floor(Math.random() * 20), // Edad entre 25-45
            gender: ['male', 'female', 'prefer-not-to-say'][Math.floor(Math.random() * 3)],
            nationality: 'Espa√±ola',
            maritalStatus: ['single', 'married', 'divorced'][Math.floor(Math.random() * 3)],
            occupation: ['Ingeniero', 'M√©dico', 'Profesor', 'Abogado', 'Comercial', 'Psic√≥logo'][Math.floor(Math.random() * 6)],
          },
          contactInfo: {
            email: user.email,
            phone: user.phone || `+34 6${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`,
            preferredContactMethod: ['email', 'phone'][Math.floor(Math.random() * 2)],
            address: {
              street: `Calle ${['Mayor', 'Principal', 'Gran V√≠a', 'Alcal√°', 'Serrano'][Math.floor(Math.random() * 5)]} ${Math.floor(Math.random() * 200) + 1}`,
              city: ['Madrid', 'Barcelona', 'Valencia', 'Sevilla'][Math.floor(Math.random() * 4)],
              postalCode: `${28000 + Math.floor(Math.random() * 1000)}`,
              state: ['Madrid', 'Barcelona', 'Valencia', 'Andaluc√≠a'][Math.floor(Math.random() * 4)],
              country: 'Espa√±a',
            },
          },
          emergencyContact: {
            name: `Contacto de ${user.name.split(' ')[0]}`,
            relationship: ['Padre', 'Madre', 'Hermano', 'C√≥nyuge', 'Amigo'][Math.floor(Math.random() * 5)],
            phone: `+34 6${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`,
            email: `contacto.${user.email}`,
          },
          clinicalInfo: {
            assignedProfessionals: [],
            medicalHistory: {
              conditions: [
                ['Ansiedad', 'Depresi√≥n', 'Estr√©s laboral', 'Trastorno del sue√±o', 'Fobia social'][Math.floor(Math.random() * 5)]
              ],
              medications: [],
              allergies: [],
              surgeries: [],
              hospitalizations: [],
            },
            mentalHealthHistory: {
              previousTreatments: [],
              diagnoses: [],
              riskFactors: [],
            },
            currentTreatment: {
              goals: ['Reducir ansiedad', 'Mejorar autoestima', 'Gesti√≥n del estr√©s'],
              startDate: new Date(),
              treatmentPlan: 'Terapia cognitivo-conductual',
              frequency: 'Semanal',
              notes: 'Paciente motivado para el tratamiento',
            },
          },
          insurance: {
            hasInsurance: Math.random() > 0.5,
            paymentMethod: ['self-pay', 'insurance'][Math.floor(Math.random() * 2)],
            primaryInsurance: {
              sessionsUsed: 0,
              authorizationRequired: false,
            },
            financialAssistance: {
              approved: false,
            },
          },
          preferences: {
            language: 'es',
            communicationPreferences: {
              appointmentReminders: true,
              reminderMethods: ['email'],
              reminderTiming: [24, 2],
              newsletters: false,
              marketingCommunications: false,
            },
            appointmentPreferences: {
              preferredTimes: [],
              preferredProfessionals: [],
              sessionFormat: ['in-person', 'video'][Math.floor(Math.random() * 2)],
              sessionDuration: 50,
            },
            portalAccess: {
              enabled: true,
              twoFactorEnabled: false,
              loginNotifications: true,
            },
          },
          gdprConsent: {
            dataProcessing: {
              consented: true,
              consentDate: new Date(),
              consentMethod: 'digital',
              consentVersion: '1.0',
            },
            marketingCommunications: {
              consented: false,
              consentDate: new Date(),
              method: 'digital',
            },
            dataSharing: {
              healthcareProfessionals: true,
              insuranceProviders: false,
              emergencyContacts: true,
              researchPurposes: false,
              consentDate: new Date(),
            },
            rightToErasure: {
              requested: false,
            },
            dataPortability: {},
          },
          referral: {
            source: ['self', 'physician', 'family', 'friend'][Math.floor(Math.random() * 4)],
            referralReason: 'Necesidad de apoyo psicol√≥gico',
          },
          tags: [],
          status: 'active',
          relationships: [],
          statistics: {
            totalAppointments: 0,
            completedAppointments: 0,
            cancelledAppointments: 0,
            noShowAppointments: 0,
            totalInvoiceAmount: 0,
            totalPaidAmount: 0,
          },
          episodes: [],
          administrativeNotes: [],
          userId: user._id,
          createdBy: adminUserForPatients?._id || new mongoose.Types.ObjectId(),
          version: 1,
          createdAt: new Date(),
          updatedAt: new Date(),
        };

        const patient = new Patient(patientData);
        await patient.save();
        
        // Actualizar el usuario para linkear con el paciente
        user.patientId = patient._id;
        await user.save();
        
        logger.info(`‚úÖ Patient creado para: ${user.name}`);
        patientsCreated++;

      } catch (error: any) {
        logger.error(`‚ùå Error creando Patient para ${user.name}: ${error.message}`);
        if (error.errors) {
          Object.keys(error.errors).forEach(key => {
            logger.error(`   - ${key}: ${error.errors[key].message}`);
          });
        }
      }
    }

    logger.info(`üìä Registros Patient creados: ${patientsCreated}`);

    // Mostrar resumen final
    const totalUsers = await User.countDocuments();
    const totalProfessionals = await Professional.countDocuments();
    const totalPatients = await Patient.countDocuments();
    
    console.log('\nüéâ ¬°INICIALIZACI√ìN COMPLETADA!');
    console.log('\nüìä RESUMEN DE LA BASE DE DATOS:');
    console.log(`   üë§ Usuarios: ${totalUsers}`);
    console.log(`   üë®‚Äç‚öïÔ∏è Profesionales: ${totalProfessionals}`);
    console.log(`   üè• Pacientes: ${totalPatients}`);
    
    console.log('\nüîê CREDENCIALES DE PRUEBA ADICIONALES:');
    console.log('üë®‚Äç‚öïÔ∏è PROFESIONALES:');
    console.log('   Dr. Carlos Mendoza: carlos.mendoza@arribapsicologia.com / Professional2024!');
    console.log('   Dra. Ana Rodr√≠guez: ana.rodriguez@arribapsicologia.com / Professional2024!');
    console.log('   Dr. Miguel Santos: miguel.santos@arribapsicologia.com / Professional2024!');
    
    console.log('\nüè• PACIENTES:');
    console.log('   Mar√≠a Garc√≠a: maria.garcia@email.com / Patient2024!');
    console.log('   Juan P√©rez: juan.perez@email.com / Patient2024!');
    console.log('   Carmen L√≥pez: carmen.lopez@email.com / Patient2024!');
    console.log('   Pedro Mart√≠n: pedro.martin@email.com / Patient2024!');
    console.log('   Luc√≠a Fern√°ndez: lucia.fernandez@email.com / Patient2024!');
    console.log('   Diego Ruiz: diego.ruiz@email.com / Patient2024!');
    console.log('   Sandra Torres: sandra.torres@email.com / Patient2024!');
    
    console.log('\nüåê Accede a la aplicaci√≥n en: http://localhost:3000');
    console.log('üìã Panel de administraci√≥n: http://localhost:3000/admin');

  } catch (error) {
    console.error('‚ùå Database initialization failed:', error);
    logger.error('Database initialization error:', error);
    throw error;
  } finally {
    try {
      await database.disconnect();
      console.log('‚úÖ Database disconnected');
    } catch (error) {
      console.warn('‚ö†Ô∏è  Warning during database disconnect:', error);
    }
  }
}

// Main execution
async function main(): Promise<void> {
  const args = process.argv.slice(2);
  
  const options: InitOptions = {
    skipAdmin: args.includes('--skip-admin'),
    skipSeed: args.includes('--skip-seed'),
  };

  // Custom admin data from environment variables
  if (process.env.ADMIN_NAME || process.env.ADMIN_EMAIL || process.env.ADMIN_PASSWORD) {
    options.adminData = {
      name: process.env.ADMIN_NAME || 'Administrador Principal',
      email: process.env.ADMIN_EMAIL || 'admin@arribapsicologia.com',
      password: process.env.ADMIN_PASSWORD || 'SecureAdmin2024!',
      phone: process.env.ADMIN_PHONE || '+34600000000',
    };
  }

  await initializeDatabase(options);
}

// Handle errors
process.on('unhandledRejection', (reason, promise) => {
  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);
  process.exit(1);
});

process.on('uncaughtException', (error) => {
  console.error('‚ùå Uncaught Exception:', error);
  process.exit(1);
});

// Run the script
if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch((error) => {
    console.error('‚ùå Initialization failed:', error);
    process.exit(1);
  });
}

export { initializeDatabase };
export default main;
